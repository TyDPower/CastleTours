@inject ILocalStorageService LocalStorage
@inject StoreConfig StoreConfig

<div class="modal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">@SelectedTour.Name</h5>
        <button type="button" class="btn-close" @onclick="OnClose"></button>
      </div>
      <div class="modal-body">
        <div>
            <h5>@SelectedTour.Name</h5>
            <h6><span class="oi oi-british-pound"></span> @SelectedTour.GetTicketPriceFormatted()</h6>
        </div>
        <br/>
        @if (SelectedTour.Addons.Count() > 0)
        {
            <div>
                <h5>Tour Extras</h5>
                @foreach (var i in SelectedTour.Addons)
                {
                    <input type="checkbox" id="@i.Id" @onclick="e => HandleAddonsCheckBox(i)">
                    <label for="@i.Id"> @i.Name $@i.GetFormattedPrice()pp </label><br />
                }
            </div>
            <br/>
        }
        <div>
            <label>Ticket QTY</label> &nbsp;
            <select id="ticketQty" @onchange="e => HandleTicketQtyUpdate(e)">
                @for (var i=1; i<=StoreConfig.MaxTicketQty; i++)
                {
                    <option value="@i">@i</option>
                }
            </select>
        </div>
        <div>
            <hr />
            <h5>Ticket total: <span class="oi oi-british-pound"></span> @HandleTicketCost()</h5>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" @onclick="OnClose">
            <i class="fas fa-times"></i>
        </button>
        <button type="button" class="btn btn-primary" @onclick="AddTicketToCart">
            <i class="fas fa-cart-arrow-down"></i> Add to cart
        </button>
      </div>
    </div>
  </div>
</div>

@code {
    [Parameter] public EventCallback OnConfirm { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public Tour SelectedTour { get; set; }

    Ticket ConfigureTicket = new Ticket();
    List<Addon> SelectedAddons = new List<Addon>();

    protected void HandleAddonsCheckBox(Addon addon)
    {
        var item = SelectedAddons.Find(i => i.Id == addon.Id);

        if (item != null) 
        {
            SelectedAddons.Remove(item);
            ConfigureTicket.AddRemoveAddons(item.Name, false);
        }
        else 
        {
            SelectedAddons.Add(addon);
            ConfigureTicket.AddRemoveAddons(addon.Name);
        }
    }

    protected void HandleTicketQtyUpdate(ChangeEventArgs e)
    {
        ConfigureTicket.UpdateTicketQty(Convert.ToInt32(e.Value));
    }

    protected string HandleTicketCost()
    {
        decimal addonsTotal = 0.00m;
        decimal tourCost = SelectedTour.GetTicketPrice();
        int ticketQty = ConfigureTicket.Qty;
        decimal ticketCost = 0.00m;        

        foreach (var i in SelectedAddons)
        {
            addonsTotal += i.Price;
        }

        ticketCost = (tourCost + addonsTotal) * ticketQty;
        ConfigureTicket.UpdateTicketCost(ticketCost);

        return ticketCost.ToString("0.00");
    }

    protected async Task AddTicketToCart()
    {
        ConfigureTicket.SetSelectedTourName(SelectedTour.Name);
        ConfigureTicket.SetCustomerName("Tyrone Power");
        var cart = await LocalStorage.GetItemAsync<List<Ticket>>("cart");
        if (cart == null)
        {
            cart = new List<Ticket>();
        }
        cart.Add(ConfigureTicket);
        OnClose.InvokeAsync();
        await LocalStorage.SetItemAsync("cart", cart);
    }
}
